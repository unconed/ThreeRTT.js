(function(){function b(a,f,r){if(a===f)return 0!==a||1/a==1/f;if(null==a||null==f)return a===f;a._chain&&(a=a._wrapped);f._chain&&(f=f._wrapped);if(a.isEqual&&c.isFunction(a.isEqual))return a.isEqual(f);if(f.isEqual&&c.isFunction(f.isEqual))return f.isEqual(a);var d=p.call(a);if(d!=p.call(f))return!1;switch(d){case "[object String]":return a==""+f;case "[object Number]":return a!=+a?f!=+f:0==a?1/a==1/f:a==+f;case "[object Date]":case "[object Boolean]":return+a==+f;case "[object RegExp]":return a.source==
f.source&&a.global==f.global&&a.multiline==f.multiline&&a.ignoreCase==f.ignoreCase}if("object"!=typeof a||"object"!=typeof f)return!1;for(var l=r.length;l--;)if(r[l]==a)return!0;r.push(a);var l=0,v=!0;if("[object Array]"==d){if(l=a.length,v=l==f.length)for(;l--&&(v=l in a==l in f&&b(a[l],f[l],r)););}else{if("constructor"in a!="constructor"in f||a.constructor!=f.constructor)return!1;for(var e in a)if(c.has(a,e)&&(l++,!(v=c.has(f,e)&&b(a[e],f[e],r))))break;if(v){for(e in f)if(c.has(f,e)&&!l--)break;
v=!l}}r.pop();return v}var d=this,e=d._,k={},g=Array.prototype,m=Object.prototype,h=g.slice,t=g.unshift,p=m.toString,w=m.hasOwnProperty,s=g.forEach,E=g.map,F=g.reduce,G=g.reduceRight,H=g.filter,I=g.every,J=g.some,y=g.indexOf,K=g.lastIndexOf,m=Array.isArray,N=Object.keys,z=Function.prototype.bind,c=function(a){return new u(a)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports._=c):d._=c;c.VERSION="1.3.3";var q=c.each=c.forEach=function(a,
f,r){if(null!=a)if(s&&a.forEach===s)a.forEach(f,r);else if(a.length===+a.length)for(var b=0,d=a.length;b<d&&!(b in a&&f.call(r,a[b],b,a)===k);b++);else for(b in a)if(c.has(a,b)&&f.call(r,a[b],b,a)===k)break};c.map=c.collect=function(a,f,c){var b=[];if(null==a)return b;if(E&&a.map===E)return a.map(f,c);q(a,function(a,d,e){b[b.length]=f.call(c,a,d,e)});a.length===+a.length&&(b.length=a.length);return b};c.reduce=c.foldl=c.inject=function(a,f,b,d){var l=2<arguments.length;null==a&&(a=[]);if(F&&a.reduce===
F)return d&&(f=c.bind(f,d)),l?a.reduce(f,b):a.reduce(f);q(a,function(a,c,e){l?b=f.call(d,b,a,c,e):(b=a,l=!0)});if(!l)throw new TypeError("Reduce of empty array with no initial value");return b};c.reduceRight=c.foldr=function(a,f,b,d){var l=2<arguments.length;null==a&&(a=[]);if(G&&a.reduceRight===G)return d&&(f=c.bind(f,d)),l?a.reduceRight(f,b):a.reduceRight(f);var e=c.toArray(a).reverse();d&&!l&&(f=c.bind(f,d));return l?c.reduce(e,f,b,d):c.reduce(e,f)};c.find=c.detect=function(a,f,c){var b;L(a,function(a,
d,e){if(f.call(c,a,d,e))return b=a,!0});return b};c.filter=c.select=function(a,f,c){var b=[];if(null==a)return b;if(H&&a.filter===H)return a.filter(f,c);q(a,function(a,d,e){f.call(c,a,d,e)&&(b[b.length]=a)});return b};c.reject=function(a,f,c){var b=[];if(null==a)return b;q(a,function(a,d,e){f.call(c,a,d,e)||(b[b.length]=a)});return b};c.every=c.all=function(a,f,c){var b=!0;if(null==a)return b;if(I&&a.every===I)return a.every(f,c);q(a,function(a,d,e){if(!(b=b&&f.call(c,a,d,e)))return k});return!!b};
var L=c.some=c.any=function(a,f,b){f||(f=c.identity);var d=!1;if(null==a)return d;if(J&&a.some===J)return a.some(f,b);q(a,function(a,c,e){if(d||(d=f.call(b,a,c,e)))return k});return!!d};c.include=c.contains=function(a,f){var b=!1;return null==a?b:y&&a.indexOf===y?-1!=a.indexOf(f):b=L(a,function(a){return a===f})};c.invoke=function(a,f){var b=h.call(arguments,2);return c.map(a,function(a){return(c.isFunction(f)?f||a:a[f]).apply(a,b)})};c.pluck=function(a,f){return c.map(a,function(a){return a[f]})};
c.max=function(a,f,b){if(!f&&c.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!f&&c.isEmpty(a))return-Infinity;var d={computed:-Infinity};q(a,function(a,c,e){c=f?f.call(b,a,c,e):a;c>=d.computed&&(d={value:a,computed:c})});return d.value};c.min=function(a,f,b){if(!f&&c.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!f&&c.isEmpty(a))return Infinity;var d={computed:Infinity};q(a,function(a,c,e){c=f?f.call(b,a,c,e):a;c<d.computed&&(d={value:a,computed:c})});return d.value};c.shuffle=
function(a){var f=[],b;q(a,function(a,c){b=Math.floor(Math.random()*(c+1));f[c]=f[b];f[b]=a});return f};c.sortBy=function(a,b,d){var e=c.isFunction(b)?b:function(a){return a[b]};return c.pluck(c.map(a,function(a,b,c){return{value:a,criteria:e.call(d,a,b,c)}}).sort(function(a,b){var c=a.criteria,f=b.criteria;return void 0===c?1:void 0===f?-1:c<f?-1:c>f?1:0}),"value")};c.groupBy=function(a,b){var d={},e=c.isFunction(b)?b:function(a){return a[b]};q(a,function(a,b){var c=e(a,b);(d[c]||(d[c]=[])).push(a)});
return d};c.sortedIndex=function(a,b,d){d||(d=c.identity);for(var e=0,l=a.length;e<l;){var h=e+l>>1;d(a[h])<d(b)?e=h+1:l=h}return e};c.toArray=function(a){return a?c.isArray(a)||c.isArguments(a)?h.call(a):a.toArray&&c.isFunction(a.toArray)?a.toArray():c.values(a):[]};c.size=function(a){return c.isArray(a)?a.length:c.keys(a).length};c.first=c.head=c.take=function(a,b,c){return null==b||c?a[0]:h.call(a,0,b)};c.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))};c.last=function(a,b,
c){return null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))};c.rest=c.tail=function(a,b,c){return h.call(a,null==b||c?1:b)};c.compact=function(a){return c.filter(a,function(a){return!!a})};c.flatten=function(a,b){return c.reduce(a,function(a,d){if(c.isArray(d))return a.concat(b?d:c.flatten(d));a[a.length]=d;return a},[])};c.without=function(a){return c.difference(a,h.call(arguments,1))};c.uniq=c.unique=function(a,b,d){d=d?c.map(a,d):a;var e=[];3>a.length&&(b=!0);c.reduce(d,function(d,r,h){(b?
c.last(d)===r&&d.length:c.include(d,r))||(d.push(r),e.push(a[h]));return d},[]);return e};c.union=function(){return c.uniq(c.flatten(arguments,!0))};c.intersection=c.intersect=function(a){var b=h.call(arguments,1);return c.filter(c.uniq(a),function(a){return c.every(b,function(b){return 0<=c.indexOf(b,a)})})};c.difference=function(a){var b=c.flatten(h.call(arguments,1),!0);return c.filter(a,function(a){return!c.include(b,a)})};c.zip=function(){for(var a=h.call(arguments),b=c.max(c.pluck(a,"length")),
d=Array(b),e=0;e<b;e++)d[e]=c.pluck(a,""+e);return d};c.indexOf=function(a,b,d){if(null==a)return-1;var e;if(d)return d=c.sortedIndex(a,b),a[d]===b?d:-1;if(y&&a.indexOf===y)return a.indexOf(b);d=0;for(e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1};c.lastIndexOf=function(a,b){if(null==a)return-1;if(K&&a.lastIndexOf===K)return a.lastIndexOf(b);for(var c=a.length;c--;)if(c in a&&a[c]===b)return c;return-1};c.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0);c=arguments[2]||1;for(var d=
Math.max(Math.ceil((b-a)/c),0),e=0,h=Array(d);e<d;)h[e++]=a,a+=c;return h};var M=function(){};c.bind=function(a,b){var d,e;if(a.bind===z&&z)return z.apply(a,h.call(arguments,1));if(!c.isFunction(a))throw new TypeError;e=h.call(arguments,2);return d=function(){if(!(this instanceof d))return a.apply(b,e.concat(h.call(arguments)));M.prototype=a.prototype;var c=new M,g=a.apply(c,e.concat(h.call(arguments)));return Object(g)===g?g:c}};c.bindAll=function(a){var b=h.call(arguments,1);0==b.length&&(b=c.functions(a));
q(b,function(b){a[b]=c.bind(a[b],a)});return a};c.memoize=function(a,b){var d={};b||(b=c.identity);return function(){var e=b.apply(this,arguments);return c.has(d,e)?d[e]:d[e]=a.apply(this,arguments)}};c.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)};c.defer=function(a){return c.delay.apply(c,[a,1].concat(h.call(arguments,1)))};c.throttle=function(a,b){var d,e,h,g,k,p,m=c.debounce(function(){k=g=!1},b);return function(){d=this;e=arguments;h||
(h=setTimeout(function(){h=null;k&&a.apply(d,e);m()},b));g?k=!0:p=a.apply(d,e);m();g=!0;return p}};c.debounce=function(a,b,c){var d;return function(){var e=this,h=arguments;c&&!d&&a.apply(e,h);clearTimeout(d);d=setTimeout(function(){d=null;c||a.apply(e,h)},b)}};c.once=function(a){var b=!1,c;return function(){if(b)return c;b=!0;return c=a.apply(this,arguments)}};c.wrap=function(a,b){return function(){var c=[a].concat(h.call(arguments,0));return b.apply(this,c)}};c.compose=function(){var a=arguments;
return function(){for(var b=arguments,c=a.length-1;0<=c;c--)b=[a[c].apply(this,b)];return b[0]}};c.after=function(a,b){return 0>=a?b():function(){if(1>--a)return b.apply(this,arguments)}};c.keys=N||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[],d;for(d in a)c.has(a,d)&&(b[b.length]=d);return b};c.values=function(a){return c.map(a,c.identity)};c.functions=c.methods=function(a){var b=[],d;for(d in a)c.isFunction(a[d])&&b.push(d);return b.sort()};c.extend=function(a){q(h.call(arguments,
1),function(b){for(var c in b)a[c]=b[c]});return a};c.pick=function(a){var b={};q(c.flatten(h.call(arguments,1)),function(c){c in a&&(b[c]=a[c])});return b};c.defaults=function(a){q(h.call(arguments,1),function(b){for(var c in b)null==a[c]&&(a[c]=b[c])});return a};c.clone=function(a){return c.isObject(a)?c.isArray(a)?a.slice():c.extend({},a):a};c.tap=function(a,b){b(a);return a};c.isEqual=function(a,c){return b(a,c,[])};c.isEmpty=function(a){if(null==a)return!0;if(c.isArray(a)||c.isString(a))return 0===
a.length;for(var b in a)if(c.has(a,b))return!1;return!0};c.isElement=function(a){return!(!a||1!=a.nodeType)};c.isArray=m||function(a){return"[object Array]"==p.call(a)};c.isObject=function(a){return a===Object(a)};c.isArguments=function(a){return"[object Arguments]"==p.call(a)};c.isArguments(arguments)||(c.isArguments=function(a){return!(!a||!c.has(a,"callee"))});c.isFunction=function(a){return"[object Function]"==p.call(a)};c.isString=function(a){return"[object String]"==p.call(a)};c.isNumber=function(a){return"[object Number]"==
p.call(a)};c.isFinite=function(a){return c.isNumber(a)&&isFinite(a)};c.isNaN=function(a){return a!==a};c.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==p.call(a)};c.isDate=function(a){return"[object Date]"==p.call(a)};c.isRegExp=function(a){return"[object RegExp]"==p.call(a)};c.isNull=function(a){return null===a};c.isUndefined=function(a){return void 0===a};c.has=function(a,b){return w.call(a,b)};c.noConflict=function(){d._=e;return this};c.identity=function(a){return a};c.times=
function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)};c.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};c.result=function(a,b){if(null==a)return null;var d=a[b];return c.isFunction(d)?d.call(a):d};c.mixin=function(a){q(c.functions(a),function(b){O(b,c[b]=a[b])})};var P=0;c.uniqueId=function(a){var b=P++;return a?a+b:b};c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,
escape:/<%-([\s\S]+?)%>/g};var A=/.^/,x={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},B;for(B in x)x[x[B]]=B;var Q=/\\|'|\r|\n|\t|\u2028|\u2029/g,R=/\\(\\|'|r|n|t|u2028|u2029)/g,C=function(a){return a.replace(R,function(a,b){return x[b]})};c.template=function(a,b,d){d=c.defaults(d||{},c.templateSettings);a="__p+='"+a.replace(Q,function(a){return"\\"+x[a]}).replace(d.escape||A,function(a,b){return"'+\n_.escape("+C(b)+")+\n'"}).replace(d.interpolate||A,function(a,b){return"'+\n("+
C(b)+")+\n'"}).replace(d.evaluate||A,function(a,b){return"';\n"+C(b)+"\n;__p+='"})+"';\n";d.variable||(a="with(obj||{}){\n"+a+"}\n");a="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+a+"return __p;\n";var e=new Function(d.variable||"obj","_",a);if(b)return e(b,c);b=function(a){return e.call(this,a,c)};b.source="function("+(d.variable||"obj")+"){\n"+a+"}";return b};c.chain=function(a){return c(a).chain()};var u=function(a){this._wrapped=a};c.prototype=u.prototype;
var D=function(a,b){return b?c(a).chain():a},O=function(a,b){u.prototype[a]=function(){var a=h.call(arguments);t.call(a,this._wrapped);return D(b.apply(c,a),this._chain)}};c.mixin(c);q("pop push reverse shift sort splice unshift".split(" "),function(a){var b=g[a];u.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;"shift"!=a&&"splice"!=a||0!==d||delete c[0];return D(c,this._chain)}});q(["concat","join","slice"],function(a){var b=g[a];u.prototype[a]=function(){return D(b.apply(this._wrapped,
arguments),this._chain)}});u.prototype.chain=function(){this._chain=!0;return this};u.prototype.value=function(){return this._wrapped}}).call(this);var MicroEvent=function(){};
MicroEvent.prototype={bind:function(b,d){this._events=this._events||{};this._events[b]=this._events[b]||[];this._events[b].push(d)},unbind:function(b,d){this._events=this._events||{};!1!==b in this._events&&this._events[b].splice(this._events[b].indexOf(d),1)},trigger:function(b){this._events=this._events||{};if(!1!==b in this._events)for(var d=0;d<this._events[b].length;d++)this._events[b][d].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(b){for(var d=["bind","unbind","trigger"],e=0;e<d.length;e++)b.prototype[d[e]]=MicroEvent.prototype[d[e]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(b){for(var d in b)if(!window[d])throw"Error: ThreeRTT requires "+b[d];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};ThreeRTT.World=function(){};ThreeRTT.getShader=function(b){var d=document.getElementById(b);return d&&d.innerText||b};
_.loop=function(b,d){for(var e=0;e<b;++e)d(e)};ThreeRTT.getShader=function(b){var d=document.getElementById(b);return d&&(d.innerText||d.textContent)||b};ThreeRTT.isPowerOfTwo=function(b){return 0===(b&b-1)};ThreeRTT.toTarget=function(b){return ThreeRTT.Stage&&b instanceof ThreeRTT.Stage?b.target:ThreeRTT.World&&b instanceof ThreeRTT.World?b.target():b};ThreeRTT.toTexture=function(b,d){b=ThreeRTT.toTarget(b);return ThreeRTT.RenderTarget&&b instanceof ThreeRTT.RenderTarget?b.read():b};
MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(b){for(var d=["bind","unbind","trigger","on","emit"],e=0;e<d.length;e++)b.prototype[d[e]]=MicroEvent.prototype[d[e]]};
ThreeRTT.Stage=function(b,d){d=_.extend({history:0,camera:{},scene:null},d);d.camera.aspect=d.camera.aspect||d.width/d.height;this.camera=ThreeRTT.Camera(d.camera);this.target=new ThreeRTT.RenderTarget(b,d);this.reset();this.size(d.width,d.height)};
ThreeRTT.Stage.prototype={options:function(){return this.target.options},reset:function(){this.scenes=[];this.passes=[]},paint:function(b,d){var e=new THREE.Scene;if(!d){var k=new ThreeRTT.FragmentMaterial(this,"generic-fragment-texture"),k=this._surface(k);e.add(k)}e.add(b);this.scenes.push(e);this.passes.push(1)},iterate:function(b,d){var e=this._surface(d),k=new THREE.Scene;k.add(e);this.scenes.push(k);this.passes.push(b);return this},fragment:function(b){this.iterate(1,b);return this},size:function(b,
d){b=Math.floor(b);d=Math.floor(d);this.camera.aspect=b/d;this.camera.updateProjectionMatrix();this.target.size(b,d);return this},read:function(b){return this.target.read(b)},uniform:function(){return this.target.uniform()},render:function(){this.target.clear();_.each(this.passes,function(b,d){_.loop(b,function(b){this.target.render(this.scenes[d],this.camera)}.bind(this))}.bind(this));return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.scenes=
[];this.passes=[];this.target=this.camera=null},_surface:function(b){var d=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{});d.frustumCulled=!1;d.material=b;d.renderDepth=Infinity;return d}};ThreeRTT.Compose=function(b,d,e,k){THREE.Object3D.call(this);b=new ThreeRTT.FragmentMaterial(b,d,e,k);d=new ThreeRTT.ScreenGeometry;b=this.mesh=new THREE.Mesh(d,b);b.frustumCulled=!1;this.add(b)};ThreeRTT.Compose.prototype=new THREE.Object3D;
ThreeRTT.Camera=function(b){if(b instanceof THREE.Camera)return b;b=_.extend({aspect:1,far:1E4,fov:85,near:.01,ortho:!1,scale:1},b);if(b.ortho){var d=b.scale,e=b.aspect;return new THREE.OrthographicCamera(-d*e,d*e,-d,d,b.near,b.far)}return new THREE.PerspectiveCamera(b.fov,b.aspect,b.near,b.far)};
ThreeRTT.RenderTarget=function(b,d){this.options=d=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!1,stencil:!1},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},d);this.renderer=b;ThreeRTT.isPowerOfTwo(d.width)&&ThreeRTT.isPowerOfTwo(d.height)||d.texture.minFilter||(d.texture.minFilter=THREE.LinearFilter);this.history(this.options.history,!0);this.size(d.width,d.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(b){b=Math.max(0,Math.min(this.options.history,Math.abs(b||0)));return this.virtuals[b]},write:function(){return this.targets[this.index]},history:function(b,d){void 0!==b&&(this._history=b,this.buffers=b+2,d||this.allocate());return this._history},size:function(b,d){void 0!==b&&void 0!==d&&(this.width=Math.max(1,Math.floor(b)),this.height=Math.max(1,Math.floor(d)),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},
allocate:function(){this.deallocateTargets();this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(b){b.dispose&&b.dispose()}.bind(this))},allocateTargets:function(){var b=this.options;n=this.buffers;var d=this.targets=[];_.loop(n,function(e){d.push(new THREE.WebGLRenderTarget(this.width,this.height,b.texture));d[e].__index=e}.bind(this))},allocateVirtuals:function(){var b=this.targets[0],d=this.virtuals||[];n=Math.max(1,this.buffers-1);n>d.length?
_.loop(n-d.length,function(){d.push(b.clone())}.bind(this)):d=d.slice(0,n);_.each(d,function(b,d){b.width=this.width;b.height=this.height;b.__index=d}.bind(this));this.virtuals=d;this.index=-1;this.advance()},advance:function(){var b=this.targets,d=this.virtuals,e=this.index,k=this.buffers,g=d.length;this.index=e=(e+1)%k;_.loop(g,function(m){var h=d[m];m=b[(g-m+e)%k];h.__webglTexture=m.__webglTexture;h.__webglFramebuffer=m.__webglFramebuffer;h.__webglRenderbuffer=m.__webglRenderbuffer;h.__index=m.__index})},
clear:function(){var b=this.options,d=b.clear,e=this.renderer,k=e.getClearColor().clone(),g=e.getClearAlpha();e.setClearColor(b.clearColor,b.clearAlpha);e.clearTarget(this.write(),d.color,d.depth,d.stencil);e.setClearColor(k,g)},render:function(b,d){this.emit("render",b,d);var e=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(b,d,this.write());this.renderer.autoClear=e;this.options.autoAdvance&&this.advance()},uniform:function(b){var d=this.history();if(d){var e=
[];_.loop(d+1,function(b){e.push(this.read(-b))}.bind(this));return{type:"tv",value:e,count:d+1}}return{type:"t",value:b,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.ShaderMaterial=function(b,d,e,k,g){if(k instanceof Array){var m={};_.each(k,function(b,d){m["texture"+(i+1)]=b});k=m}else if(k instanceof THREE.Texture||k instanceof ThreeRTT.World||k instanceof THREE.WebGLRenderTarget)k={texture1:k};b instanceof Array||(b=[b]);b=_.map(b,function(b){return ThreeRTT.toTarget(b)});g=_.extend(g||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(k,function(b,d){g[d]={type:"t",value:ThreeRTT.toTexture(b)}});_.each(b,function(b,d){var e="texture"+(d+
1);b.read&&!g[e]&&(g[e]={type:"t",value:b.read()})});g.texture1&&!g.texture&&(g.texture=g.texture1);b[0].on("render",function(){var d=b[0].options.texture,e=d.wrapT,k={1E3:0,1001:1,1002:0},m=g.sampleStep.value;m.x=1/(b[0].width-(k[d.wrapS]||0));m.y=1/(b[0].height-(k[e]||0))});return new THREE.ShaderMaterial({uniforms:g,vertexShader:ThreeRTT.getShader(d||"generic-vertex"),fragmentShader:ThreeRTT.getShader(e||"generic-fragment-texture")})};
ThreeRTT.FragmentMaterial=function(b,d,e,k){b=new ThreeRTT.ShaderMaterial(b,"generic-vertex-screen",d,e,k);b.side=THREE.DoubleSide;b.depthTest=!1;b.depthWrite=!1;b.transparent=!0;b.blending=THREE.NoBlending;return b};
ThreeRTT.ScaleMaterial=function(b,d,e){var k={};b=ThreeRTT.toTarget(b);d=ThreeRTT.toTarget(d);k=_.extend(k,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:b.read()}});d.on("render",function(){var g=b,h=d,t=h.height*e/g.height,p=k.sampleAlignment.value;p.x=h.width*e/g.width;p.y=t});var g=new THREE.ShaderMaterial({uniforms:k,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")});g.side=THREE.DoubleSide;g.depthTest=
!1;g.depthWrite=!1;g.transparent=!0;g.blending=THREE.NoBlending;return g};ThreeRTT.DownsampleMaterial=function(b,d){return new ThreeRTT.ScaleMaterial(b,d,2)};ThreeRTT.UpsampleMaterial=function(b,d){return new ThreeRTT.ScaleMaterial(b,d,.5)};
ThreeRTT.RaytraceMaterial=function(b,d,e,k,g){b instanceof Array||(b=[b]);e=new ThreeRTT.ShaderMaterial(b,"raytrace-vertex-screen",e,k,g);g=_.extend(e.uniforms||{},{raytraceViewport:{type:"v2",value:new THREE.Vector2},raytracePosition:{type:"v3",value:new THREE.Vector3},raytraceMatrix:{type:"m4",value:new THREE.Matrix4}});b=ThreeRTT.toTarget(b[0]);var m=new THREE.Vector3;b.on("render",function(b){d.updateMatrixWorld();d.fov&&(b=Math.tan(d.fov*\u03c0/360),g.raytraceViewport.value.set(b*d.aspect,b));
d.matrixWorld&&(g.raytraceMatrix.value.copy(d.matrixWorld),g.raytraceMatrix.value.setPosition(m),g.raytracePosition.value.getPositionFromMatrix(d.matrixWorld))});return e};ThreeRTT.Display=function(b,d,e){b instanceof Array||(b=[b]);this.gx=d||b.length;this.gy=e||1;this.targets=b;this.n=b.length;THREE.Object3D.call(this);this.make()};
ThreeRTT.Display.prototype=_.extend(new THREE.Object3D,{make:function(){for(var b=this.n,d=this.gx,e=this.gy,k=this.targets,g=(d-1)/2,m=(e-1)/2,h=new THREE.PlaneGeometry(1,1,1,1),t=0,p=0;t<b&&p<e;++p)for(var w=0;t<b&&w<d;++w,++t){var s=new THREE.MeshBasicMaterial({color:16777215,map:ThreeRTT.toTexture(k[t]),fog:!1});s.side=THREE.DoubleSide;s=new THREE.Mesh(h,s);s.renderDepth=1E4+Math.random();this.add(s);1<d&&(s.position.x=-g+w);1<e&&(s.position.y=m-p)}}});
